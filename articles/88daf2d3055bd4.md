---
title: "データパイプラインにおける状態管理の要件と、それに基づくRDBMS / NoSQLの選択"
emoji: "🐕"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

データパイプラインを設計・運用するエンジニアにとって、「状態管理」は避けて通れないテーマです。どのジョブが完了したか、どのデータが処理済みか。これらの状態を正確かつ効率的に管理できなければ、並列処理の破綻やデータの不整合といった深刻な問題を招きます。

本記事では、実務で経験したデータパイプラインのリファクタリングを題材に、状態管理基盤の技術選定プロセスを共有します。具体的には、以下の内容を扱います。

- データパイプラインにおける状態管理の要件整理
- RDBMS と NoSQL それぞれのメリット・限界
- なぜ DynamoDB を選択したのか
- 移行後に得られた改善点と、採用時の注意点

## 背景：なぜデータパイプラインの状態管理を見直したのか

私たちのチームでは、複数のデータソースから情報を収集・加工し、分析基盤へ連携するデータパイプラインを運用しています。
初期実装では、開発スピードを優先し、状態管理を S3 へのファイル書き込みで実現していました。具体的には、各ジョブの処理状況を JSON ファイルとして S3 に保存し、後続処理がそのファイルを参照する構成です。

この方式は、以下の理由から当時は合理的な選択でした。

- 実装がシンプルで、すぐに動くものが作れる
- 追加のインフラ（データベース等）が不要
- 小規模な段階では十分に機能する

しかし、顧客数の増加や並列処理の拡大に伴い、この構成には構造的な限界があることが見えてきました。

## 問題：S3ベースの状態管理が抱えていた構造的課題

S3 はオブジェクトストレージであり、原子的な更新や条件付き書き込みを前提とした状態管理には向いていない。  
その結果、以下のような問題が発生する可能性があった。

- 並列ワーカーによる更新時にレースコンディションが発生する  
- 状態更新が「最後に書き込まれたものが常に採用される」挙動になる  
- 状態の読み込み・書き込み時にレイテンシーが発生し、パフォーマンスが劣化する  

これらは、データパイプラインの並列性が高まるほど顕在化する問題だった。近い将来複数顧客を獲得する際に、障害となる問題である。

## データパイプラインにおける「状態管理」に求められる要件

今回のデータパイプライン処理において、状態管理基盤には以下の要件が求められた。

- 並列ワーカーからの高頻度な状態更新に耐えられること
- 単一エンティティに対して条件付き更新が可能であること
- レースコンディションを防ぐ仕組みをアプリケーションレベルで持てること
- 状態の変更をトリガーとして、後続処理をイベント駆動で実行できること
- アプリケーションから低レイテンシーで状態参照ができること

これらの要件を満たすことが、今回の技術選定の前提となった。

## 要件に照らしたRDBMSのメリットと限界

RDBMS はトランザクションや整合性の面で非常に強力であり、状態管理という観点でも有力な選択肢になり得る。  

一方で今回のケースでは、

- 単一レコードへの高頻度な更新が集中しやすい
- 並列処理が進むとロック競合の影響を受けやすい
- 状態構造の変更頻度が高く、マイグレーションコストが無視できない
- サーバー管理やスケーリングを考慮する必要がある

といった点が、要件とのミスマッチとして浮かび上がった。

## NoSQLを選択した理由

上記の要件を満たす基盤として、DynamoDB を採用した。

- 条件付き書き込みにより、レースコンディションを防げる  
- 高い並列性を前提とした設計で、スケーラビリティを意識せずに済む  
- スキーマが柔軟で、状態構造の変更に強い  
- DynamoDB Streams を活用することで、状態変更をイベントとして扱える  
- サーバレスで運用負荷が低い

また、技術的な要件に加え、以下の実務的な理由もDynamoDB採用の決め手となった。

- 既存システムがAWS上で稼働しており、IAMやVPCとの統合が容易
- チーム内にDynamoDBの運用経験があり、学習コストが低い

これらの特性が、イベント駆動型のデータパイプラインと高い親和性を持っていた。

## 移行によって実際に得られた改善点

状態管理基盤を DynamoDB に移行したことで、以下の改善が得られた。

- 並列度を安全に引き上げられるようになった  
- アプリケーションから直接状態を参照・更新できるようになった  
- 状態取得・更新時のレイテンシーが改善し、全体のパフォーマンスが向上した  
- 状態遷移が明示的になり、処理フローの可視性が向上した  

結果として、設計面・運用面の両方で扱いやすい基盤になった。

## NoSQLを採用する上での注意点・トレードオフ

一方で、NoSQL は万能ではない。

- クエリは「アクセスパターンベース」で事前に設計する必要がある  
- JOIN や柔軟な検索はできない  
- スキーマレス＝設計不要ではなく、むしろ設計の重要性は高い  
- 後からの設計変更には、RDBMSとは異なる難しさがある  

そのため、「とりあえず NoSQL」を選ぶのではなく、要件とデータアクセスの性質を理解した上で採用することが重要である。

## まとめ：技術選定に「正解」はなく「文脈」がある

RDBMS と NoSQL のどちらが優れているかではなく、**どの文脈・どの要件に対して適しているか** が技術選定において最も重要である。  

今回のケースでは、イベント駆動型のデータパイプラインと状態管理という文脈において、NoSQL（DynamoDB）が最適な選択肢だった。
